<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calculator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="../../style.css">

  <style>
    .card-group-bg {
      /* background-color: #edf5f7; */
      width: 100%;
      padding: 20px;
    }
  </style>

  <style>
    body {
      /* overflow: hidden; */
    }

    #main {
      /* height: calc(100vh - 56px); */
      margin-top: 80px;
      margin-bottom: 500px;
    }

    #main .contents {
      height: 100%;
    }

    #main #preview-iframe {
      height: 100%;
      border: none;
    }

    .editor {
      width: 100%;
      height: 400px;
      resize: none;
      border: none;
    }

    iframe {
      width: 100%;
      height: 100%;
    }

    .editors {}

    .preview {
      background-color: #ffffff;
      height: 100%;
      position: fixed;
      right: 0px;
    }

    #preview {
      height: 100%;
    }

    .btn.action {
      width: 100px;
    }

    #main #solution-code {
      display: none;
    }

    #main.show #solution-code {
      display: block;
    }
  </style>
</head>

<body>
  <!-- <nav class="navbar navbar-expand bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Learn to Decode</a>
    </div>
  </nav> -->
  <nav class="navbar navbar-expand-sm  navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">Learn to Decode</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link  disabled" aria-disabled="true" href="/about.html">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" aria-disabled="true" href="/contact.html">Contact</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="passcode()">Resources</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/projects/#traffic">Projects</a>
        </li>
      </ul>
    </div>
  </nav>

  <div id="main" class="fluid-container edit-and-preview">

    <div class="row contents">
      <div class="col-6 editors">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <h1>Traffic Simulator</h1>
              <div id="script" class="editor mb-3"></div>
              <button class="btn action btn-primary form-control" id="run">Run</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-6 preview">
        <div id="preview" class="col-12 g-0 mt-4">
          <iframe id="preview-iframe"></iframe>
        </div>
      </div>
    </div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.27.0/min/vs/loader.js"></script>
  <script>
    let updatePreview;
    let contenteditable = "";

    let run = (values) => {
      require.config({
        paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.27.0/min/vs",
                 espree: "https://cdn.jsdelivr.net/npm/espree@10.3.0/espree.js",
                 esprima: "https://unpkg.com/esprima@~4.0/dist/esprima.js"
         }
      });
      require(["vs/editor/editor.main"], function () {

        monaco.editor.defineTheme('default', {
          base: 'vs-dark',
          inherit: true,
          rules: [
            {
              token: "identifier",
              foreground: "9CDCFE"
            },
            {
              token: "identifier.function",
              foreground: "DCDCAA"
            },
            {
              token: "type",
              foreground: "1AAFB0"
            }
          ],
          colors: {}
        });
        monaco.editor.setTheme('default')

        var scriptEditor = monaco.editor.create(document.getElementById("script"), {
          value: values.script,
          language: "html",
          automaticLayout: true
        });

        document.getElementById("main").editors = {
          script: scriptEditor
        }

        const src = `<!DOCTYPE=html>
<html lang="en">
  <head>
    <title>Learn to Decode</title>
    <style>
      \${style}
    </style>
  </head>
  <body \${contenteditable}>
    <div id="content">
      \${body}
    </div>
    \${script}
  </body>
</html>`;
        updatePreview = function (event) {
          let template = src;
          template = template.replace("${contenteditable}", contenteditable);
          template = template.replace("${body}", values.html);
          let inputs = document.querySelectorAll("#copyright-form input");
          for (var i = 0; i < inputs.length; i++) {
            let input = inputs[i];
            if (input.value.trim() === "") {
              continue;
            }
            let slug = input.getAttribute("data-slug");
            template = template.replace(slug, input.value);
          }
          template = template.replace("${style}", values.style);
          let pageInputs = document.querySelectorAll("#page-form input");
          for (var i = 0; i < pageInputs.length; i++) {
            let input = pageInputs[i];
            if (input.value.trim() === "") {
              continue;
            }
            let slug = input.getAttribute("data-slug");
            template = template.replace(slug, input.value);
          }

          template = template.replace("${script}", scriptEditor.getValue());

          document.getElementById("preview-iframe").srcdoc = template;
        }

        const page = values.page;
        const keys = Object.keys(page);
        for (let i = 0; i < keys.length; i++) {
          let key = keys[i];
          let item = page[key];
          if (typeof item === 'string') {
            continue;
          }
          let fields = Object.keys(item);
          for (let j = 0; j < fields.length; j++) {
            let field = fields[j];
            let value = item[field];
            let selector = `#${key}-form #${field}`;
            document.querySelector(selector).value = value;
          }
        }

        document.getElementById("run").addEventListener("click", (ev) => {
          updatePreview();
        });

        updatePreview();
      });
    };
  </script>

  <script>
    (async function () {

      const getContent = async function (path) {
        const folder = window.location.hash.slice(1);
        const response = await fetch(path);
        const content = await response.text();
        return content;
      }

      const json = await getContent("page.json");
      const page = JSON.parse(json);

      document.title = page.title;

      const html = await getContent("content.txt");
      const style = await getContent("style.css");
      const script = await getContent("script.html");

      const doc = {
        page: page,
        html: html,
        css: style,
        script: script
      }
      run(doc);
    })();
  </script>


</body>

</html>